import{r as v,a1 as se,a0 as te,a as ae,b as re,o as U,ao as E,H as ie,j as e,I as l,R as q,M as j,N as p,O as g,P as b,Q as d,B as m,aj as D,U as ne,ap as F,al as o,ak as z,s as u}from"./index-CJetGwO1.js";import{C as _,a as w,b as C,d as A}from"./card-CM5R7BK3.js";import{L as de}from"./list-DDmqjVNN.js";import{P as I}from"./plus-BrZxr_o5.js";const ce=U({id:o().optional(),name:u().min(1,"Subtask name is required"),description:u().optional(),due_date:u().min(1,"Due date is required"),priority:z(["low","medium","high","critical"])}),le=U({user_id:o().min(1,"User is required"),percentage:o().min(.01).max(100)}),me=U({name:u().min(1,"Task name is required").max(255),description:u().optional(),weight:o().min(1).max(100),due_date:u().min(1,"Due date is required"),priority:z(["low","medium","high","critical"]),project_id:o().min(1,"Project is required"),section_id:o().min(1,"Section is required"),subtasks:F(ce).optional(),assignments:F(le).min(1,"At least one assignment is required")}),je=({mode:N="create",sectionId:f,initialValues:r,onSubmit:H,onCancel:P,isLoading:a})=>{const[T,M]=v.useState([]),{projects:B,fetchProjects:R,isLoading:O}=se(),{sections:Q,fetchSectionsByProject:$,isLoading:W}=te(),t=ae({resolver:re(me),defaultValues:{name:"",description:"",weight:10,due_date:"",priority:"medium",project_id:r?.project_id,section_id:f??r?.section_id,subtasks:r?.subtasks??[],assignments:r?.assignments??[]}});v.useEffect(()=>{r&&t.reset({name:r.name??"",description:r.description??"",weight:r.weight??10,due_date:r.due_date??"",priority:r.priority??"medium",project_id:r.project_id,section_id:f??r.section_id,subtasks:r.subtasks??[],assignments:r.assignments??[]})},[r,f]);const{fields:y,append:X,remove:G}=E({control:t.control,name:"subtasks"}),{fields:k,append:J,remove:K}=E({control:t.control,name:"assignments"}),c=t.watch("project_id"),S=t.watch("assignments")||[];v.useEffect(()=>{R(),Y(),r?.project_id&&$(r.project_id)},[]),v.useEffect(()=>{c&&c>0&&($(c),!f&&N==="create"&&t.setValue("section_id",0))},[c]);const Y=async()=>{try{const s=await ie.getUsers(1,100);s.success&&s.data&&M(s.data)}catch(s){console.error("Failed to fetch users:",s)}},Z=async s=>{const{project_id:i,...n}=s;await H({...n,weight:Number(n.weight),section_id:Number(n.section_id),subtasks:n.subtasks?.map(x=>({...x,due_date:x.due_date}))??[],assignments:n.assignments.map(x=>({user_id:Number(x.user_id),percentage:Number(x.percentage)})),project_id:i})},V=Q.filter(s=>s.project_id===c),L=S.map(s=>s.user_id),ee=T.filter(s=>!L.includes(s.id)),h=S.reduce((s,i)=>s+(Number(i.percentage)||0),0);return e.jsx("div",{className:"space-y-6",children:e.jsxs("form",{onSubmit:t.handleSubmit(Z),className:"space-y-6",children:[e.jsxs(_,{children:[e.jsx(w,{children:e.jsx(C,{children:N==="edit"?"Edit Task":"Task Information"})}),e.jsxs(A,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Task Name *"}),e.jsx(l,{...t.register("name"),placeholder:"Enter task name",disabled:a}),t.formState.errors.name&&e.jsx("p",{className:"text-sm text-red-500",children:t.formState.errors.name.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Weight *"}),e.jsx(l,{type:"number",...t.register("weight",{valueAsNumber:!0}),min:"1",max:"100",disabled:a})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description"}),e.jsx(q,{...t.register("description"),placeholder:"Enter task description",disabled:a,rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Due Date *"}),e.jsx(l,{type:"date",...t.register("due_date"),disabled:a})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Priority *"}),e.jsxs(j,{value:t.watch("priority"),onValueChange:s=>t.setValue("priority",s),disabled:a,children:[e.jsx(p,{children:e.jsx(g,{})}),e.jsxs(b,{children:[e.jsx(d,{value:"low",children:"Low"}),e.jsx(d,{value:"medium",children:"Medium"}),e.jsx(d,{value:"high",children:"High"}),e.jsx(d,{value:"critical",children:"Critical"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Project *"}),e.jsxs(j,{value:t.watch("project_id")?.toString()||"",onValueChange:s=>t.setValue("project_id",Number(s)),disabled:a||O,children:[e.jsx(p,{children:e.jsx(g,{placeholder:"Select project"})}),e.jsx(b,{children:B.map(s=>e.jsx(d,{value:s.id.toString(),children:s.name},s.id))})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Section *"}),e.jsxs(j,{value:t.watch("section_id")?.toString()||"",onValueChange:s=>t.setValue("section_id",Number(s)),disabled:a||W||!c,children:[e.jsx(p,{children:e.jsx(g,{placeholder:"Select section"})}),e.jsx(b,{children:V.map(s=>e.jsx(d,{value:s.id.toString(),children:s.name},s.id))})]})]})]})]}),e.jsxs(_,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between",children:[e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5"}),"Subtasks (",y.length,")"]}),e.jsxs(m,{type:"button",variant:"outline",size:"sm",onClick:()=>X({name:"",description:"",due_date:"",priority:"medium"}),disabled:a,children:[e.jsx(I,{className:"w-4 h-4 mr-2"})," Add Subtask"]})]}),e.jsxs(A,{className:"space-y-4",children:[y.map((s,i)=>e.jsxs("div",{className:"p-4 border rounded-lg space-y-3",children:["id"in s&&e.jsx("input",{type:"hidden",...t.register(`subtasks.${i}.id`)}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"font-medium",children:["Subtask ",i+1]}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",onClick:()=>G(i),disabled:a,children:e.jsx(D,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(l,{...t.register(`subtasks.${i}.name`),placeholder:"Subtask name",disabled:a}),e.jsx(l,{type:"date",...t.register(`subtasks.${i}.due_date`),disabled:a})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(q,{...t.register(`subtasks.${i}.description`),placeholder:"Subtask description",disabled:a,rows:2}),e.jsxs(j,{value:t.watch(`subtasks.${i}.priority`),onValueChange:n=>t.setValue(`subtasks.${i}.priority`,n),disabled:a,children:[e.jsx(p,{children:e.jsx(g,{})}),e.jsxs(b,{children:[e.jsx(d,{value:"low",children:"Low"}),e.jsx(d,{value:"medium",children:"Medium"}),e.jsx(d,{value:"high",children:"High"}),e.jsx(d,{value:"critical",children:"Critical"})]})]})]})]},s.id)),y.length===0&&e.jsx("p",{className:"text-muted-foreground text-center py-8",children:'No subtasks added yet. Click "Add Subtask" to create one.'})]})]}),e.jsxs(_,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between",children:[e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5"}),"User Assignments (",k.length,")",e.jsxs("span",{className:"text-sm font-normal",children:[h,"% assigned"]})]}),e.jsxs(m,{type:"button",variant:"outline",size:"sm",onClick:()=>J({user_id:0,percentage:10}),disabled:a||ee.length===0||h>=100,children:[e.jsx(I,{className:"w-4 h-4 mr-2"})," Assign User"]})]}),e.jsxs(A,{className:"space-y-4",children:[t.formState.errors.assignments&&e.jsx("p",{className:"text-sm text-red-500",children:t.formState.errors.assignments.message}),e.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full transition-all duration-300",style:{width:`${Math.min(h,100)}%`}})}),k.map((s,i)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg",children:[e.jsx("div",{className:"flex-1",children:e.jsxs(j,{value:t.watch(`assignments.${i}.user_id`)?.toString()||"",onValueChange:n=>t.setValue(`assignments.${i}.user_id`,Number(n)),disabled:a,children:[e.jsx(p,{children:e.jsx(g,{placeholder:"Select user"})}),e.jsx(b,{children:T.map(n=>e.jsx(d,{value:n.id.toString(),children:n.name},n.id))})]})}),e.jsx("div",{className:"w-24",children:e.jsx(l,{type:"number",...t.register(`assignments.${i}.percentage`,{valueAsNumber:!0}),placeholder:"%",min:"0.01",max:"100",step:"0.01",disabled:a})}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",onClick:()=>K(i),disabled:a,children:e.jsx(D,{className:"w-4 h-4"})})]},s.id)),k.length===0&&e.jsx("p",{className:"text-muted-foreground text-center py-8",children:'No users assigned yet. Click "Assign User" to add assignments.'}),h>100&&e.jsx("p",{className:"text-sm text-red-500",children:"Total assignment percentage cannot exceed 100%"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{type:"submit",disabled:a||h>100||(S?.length??0)<1,className:"bg-primary text-primary-foreground hover:bg-primary/90",children:N==="edit"?"Save Changes":"Create Task with Everything"}),P&&e.jsx(m,{type:"button",variant:"outline",onClick:P,disabled:a,children:"Cancel"})]})]})})};export{je as C};
