import{r as u,ar as T,o as P,a as L,b as I,j as e,C as v,c as M,d as E,l as w,f as b,aX as A,I as V,B as S,L as D,y as F,x as B,M as $,N as O,O as q,Q as z,V as H}from"./index-BgITtNX0.js";import{P as Q,a as X,b as k,c as G,d as J,e as K,f as U}from"./pagination-CYPnU2cm.js";import{u as W}from"./ratingsStore-d9Wg_A23.js";import{F as Y,b as Z,c as ee,d as se,e as ae}from"./form-2DfjBbDy.js";import{S as te,R as ne}from"./RatingDisplay-XG1q7D_h.js";import{u as re}from"./useRatingConfigs-DSi2AA7z.js";import{A as ie}from"./arrow-left-9GrZ1puf.js";import"./ellipsis-BF3Ijzam.js";import"./ratingConfigService-BT7V6n34.js";import"./label-BfMhAOey.js";import"./badge-CaIPABTU.js";import"./progress-yAe5PNnP.js";import"./user-CcRhympp.js";import"./calendar-B2TkdKHE.js";import"./ratingConfigsStore-tajW7pOD.js";import"./filtersStore-PdE8Hby5.js";const ce=c=>{const{taskRatings:l,taskRatingConfigs:r,taskRatingsPagination:n,isLoading:o,error:f,fetchTaskRatings:h,fetchTaskRatingConfigs:d,createTaskRating:j,updateTaskRating:p}=W(),i=typeof c=="string"?parseInt(c):c;u.useEffect(()=>{i&&!l.length&&(h(i,1),d())},[i,h,d,l.length]);const m=s=>{h(i,s)};return{taskRatings:l,taskRatingConfigs:r,pagination:n,isLoading:o,error:f,createRating:s=>j({...s,task_id:i}),updateRating:(s,x)=>p(s,x),refreshRatings:()=>h(i),goToPage:m,nextPage:()=>{n&&n.current_page<n.last_page&&m(n.current_page+1)},prevPage:()=>{n&&n.current_page>1&&m(n.current_page-1)}}},le=({taskId:c,config:l,onSubmit:r,isLoading:n})=>{const o=l.config_data,f=u.useMemo(()=>(o.fields||[]).reduce((t,s)=>(t[s.name]=0,t),{}),[o.fields]),h=u.useMemo(()=>{const t={};for(const s of o.fields||[])t[s.name]=T().min(0,{message:"Value must be at least 0"}).max(s.max_value,{message:`Max is ${s.max_value}`});return P({rating_data:P(t)})},[o.fields]),d=L({resolver:I(h),defaultValues:{rating_data:f}});u.useEffect(()=>{d.reset({rating_data:f})},[l.id]);const j=async t=>{const s={task_id:c,rating_config_id:l.id,rating_data:t.rating_data};await r(s)},p=d.watch("rating_data"),i=Object.values(p||{}).reduce((t,s)=>t+(s||0),0),m=(o.fields||[]).reduce((t,s)=>t+s.max_value,0),N=m>0?Math.round(i/m*100):0;return e.jsxs(v,{className:"bg-card border-border",children:[e.jsx(M,{children:e.jsxs(E,{className:"text-foreground flex items-center gap-2",children:[e.jsx(w,{className:"w-5 h-5"}),"Task Rating - ",l.name]})}),e.jsx(b,{children:e.jsx(Y,{...d,children:e.jsxs("form",{onSubmit:d.handleSubmit(j),className:"space-y-6",children:[e.jsx("div",{className:"space-y-6",children:(o.fields||[]).map(t=>e.jsx("div",{children:e.jsx(A,{name:`rating_data.${t.name}`,control:d.control,render:({field:s,fieldState:x})=>e.jsxs(Z,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(ee,{className:"text-foreground",children:t.name}),t.description&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:t.description})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[Number.isFinite(s.value)?s.value:0," / ",t.max_value]})]}),e.jsx(se,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(te,{value:[Number(s.value??0)],onValueChange:C=>s.onChange(C[0]),max:t.max_value,step:1,className:"flex-1",disabled:n}),e.jsx(V,{type:"number",min:0,max:t.max_value,value:s.value??0,onChange:C=>{const R=C.target.value,a=R===""?0:Number(R);s.onChange(Number.isNaN(a)?0:a)},disabled:n,className:"w-24 text-center"})]})}),x.error&&e.jsx(ae,{className:"text-destructive",children:x.error.message})]})})},t.name))}),e.jsx("div",{className:"p-4 bg-accent/20 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Total Rating"}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl font-bold text-foreground",children:[N,"%"]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[i," / ",m]})]})]})}),e.jsxs(S,{type:"submit",disabled:n,className:"w-full bg-primary text-primary-foreground hover:bg-primary/90",children:[n&&e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}),"Submit Rating"]})]})})})]})},_e=()=>{const{taskId:c}=F(),{taskRatings:l,pagination:r,isLoading:n,createRating:o,goToPage:f,nextPage:h,prevPage:d}=ce(c),{ratingConfigs:j,isLoading:p,error:i,fetchActiveRatingConfigsByType:m}=re(),[N,t]=u.useState(null);u.useEffect(()=>{m("task_rating")},[c,m]);const s=u.useMemo(()=>j,[j]);u.useEffect(()=>{s?.length?t(a=>a??s[0].id):t(null)},[s]);const x=u.useMemo(()=>s.find(a=>a.id===N)??null,[s,N]),C=async a=>{await o(a)},R=()=>{if(!r)return[];const a=[],{current_page:g,last_page:y}=r;g>3&&(a.push(1),g>4&&a.push("ellipsis-start"));for(let _=Math.max(1,g-2);_<=Math.min(y,g+2);_++)a.push(_);return g<y-2&&(g<y-3&&a.push("ellipsis-end"),a.push(y)),a};return c?e.jsx("div",{className:"min-h-screen flex flex-col",children:e.jsxs("div",{className:"flex-1 space-y-6 p-4 md:p-6 max-w-full",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(w,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground font-sans",children:"Task Ratings"}),e.jsx("p",{className:"text-muted-foreground",children:"Rate task performance and quality"})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(S,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(B,{to:`/tasks/${c}`,children:[e.jsx(ie,{className:"mr-2 h-4 w-4"}),"Back to Task"]})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(v,{className:"bg-card border-border",children:e.jsxs(b,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Config"}),e.jsx("p",{className:"text-base font-medium truncate",children:x?x.name:p?"Loading…":"—"})]}),e.jsx("div",{className:"w-64",children:e.jsxs($,{disabled:p||s.length===0,value:N?.toString()??void 0,onValueChange:a=>t(Number(a)),children:[e.jsx(O,{children:e.jsx(q,{placeholder:p?"Loading configs…":"Choose config"})}),e.jsx(z,{children:s.map(a=>e.jsx(H,{value:a.id.toString(),children:a.name},a.id))})]})})]}),i&&e.jsx("p",{className:"mt-2 text-sm text-destructive",children:String(i)})]})}),p?e.jsx("div",{className:"h-72 bg-muted animate-pulse rounded-lg"}):s.length===0?e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No active task rating configuration found"})})}):x?e.jsx(le,{taskId:parseInt(c),config:x,onSubmit:C,isLoading:n}):e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Select a configuration to start rating"})})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Previous Ratings"}),n?e.jsx("div",{className:"space-y-4",children:Array.from({length:3}).map((a,g)=>e.jsx("div",{className:"h-32 bg-muted animate-pulse rounded-lg"},g))}):l.length===0?e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No ratings yet for this task"})})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-4",children:l.map(a=>e.jsx(ne,{rating:a},a.id))}),r&&r.last_page>1&&e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",r.from||0," to ",r.to||0," of ",r.total," results"]}),e.jsx(Q,{children:e.jsxs(X,{children:[e.jsx(k,{children:e.jsx(G,{onClick:d,className:r.current_page===1?"pointer-events-none opacity-50":"cursor-pointer"})}),R().map((a,g)=>e.jsx(k,{children:a==="ellipsis-start"||a==="ellipsis-end"?e.jsx(J,{}):e.jsx(K,{onClick:()=>f(a),isActive:r.current_page===a,className:"cursor-pointer",children:a})},g)),e.jsx(k,{children:e.jsx(U,{onClick:h,className:r.current_page===r.last_page?"pointer-events-none opacity-50":"cursor-pointer"})})]})})]})})})]})]})]})]})}):e.jsx("div",{children:"Task not found"})};export{_e as default};
