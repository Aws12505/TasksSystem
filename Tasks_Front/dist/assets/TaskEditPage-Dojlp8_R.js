import{z as y,C as b,X as N,r as w,j as s,B as T,y as C,S,ah as I}from"./index-DbgasQnk.js";import{C as B,a as E,b as P,d as A}from"./card-Xp-DmDqu.js";import{u as L,s as n}from"./subtaskService-B696NCx_.js";import{C as U}from"./ComprehensiveTaskForm-We4fOXQd.js";import{A as z}from"./arrow-left-BgQEMF2o.js";import"./list-DWJwboGu.js";import"./plus-Lx9ZfKYP.js";const V=()=>{const{id:u}=y(),x=b(),g=Number(u),{task:i,taskWithAssignments:o,isLoading:h,error:c}=L(g),{updateTask:k}=N(),f=w.useMemo(()=>{if(!i)return;const a=o?.assigned_users?.map(t=>({user_id:t.id,percentage:t.pivot?.percentage??0}))??[],m=(i.subtasks||[]).map(t=>({id:t.id,name:t.name,description:t.description??"",due_date:t.due_date,priority:t.priority}));return{name:i.name,description:i.description??"",weight:i.weight,due_date:i.due_date,priority:i.priority,project_id:i.project_id,section_id:i.section_id,subtasks:m,assignments:a}},[i,o]),j=async a=>{if(!i||!await k(i.id,{name:a.name,description:a.description,weight:a.weight,due_date:a.due_date,priority:a.priority,section_id:a.section_id}))return;await I.assignUsersToTask(i.id,{assignments:a.assignments.map(e=>({user_id:e.user_id,percentage:e.percentage}))});const t=i.subtasks||[],d=a.subtasks??[],p=new Map;d.forEach(e=>{e.id&&p.set(e.id,e)});const _=new Set(t.map(e=>e.id)),l=new Set(d.filter(e=>e.id).map(e=>e.id));await Promise.all(t.filter(e=>l.has(e.id)).map(e=>{const r=p.get(e.id);return n.updateSubtask(e.id,{name:r.name,description:r.description,due_date:r.due_date,priority:r.priority})})),await Promise.all(d.filter(e=>!e.id).map(e=>n.createSubtask({name:e.name,description:e.description,due_date:e.due_date,priority:e.priority,task_id:i.id})));const v=[..._].filter(e=>!l.has(e));await Promise.all(v.map(e=>n.deleteSubtask(e))),x(`/tasks/${i.id}`)};return h?s.jsxs("div",{className:"space-y-6",children:[s.jsx("div",{className:"h-8 bg-muted animate-pulse rounded w-48"}),s.jsx("div",{className:"h-96 bg-muted animate-pulse rounded-lg"})]}):c||!i?s.jsx("div",{className:"text-center py-12",children:s.jsx("p",{className:"text-destructive",children:c||"Task not found"})}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx(T,{variant:"outline",size:"sm",asChild:!0,children:s.jsxs(C,{to:`/tasks/${i.id}`,children:[s.jsx(z,{className:"mr-2 h-4 w-4"}),"Back to Task"]})}),s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:s.jsx(S,{className:"w-6 h-6 text-primary"})}),s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-bold text-foreground font-sans",children:"Edit Task"}),s.jsxs("p",{className:"text-muted-foreground",children:["Update ",i.name]})]})]})]}),s.jsx("div",{className:"max-w-4xl",children:s.jsxs(B,{className:"bg-card border-border",children:[s.jsx(E,{children:s.jsx(P,{className:"text-foreground",children:"Task Details"})}),s.jsx(A,{children:s.jsx(U,{mode:"edit",sectionId:i.section_id,initialValues:f,onSubmit:j,isLoading:!1})})]})})]})};export{V as default};
