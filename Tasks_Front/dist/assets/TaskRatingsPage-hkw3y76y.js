import{r as l,aj as k,o as C,a as _,b as S,j as e,n as y,F as w,aJ as T,d as I,e as M,f as E,I as L,g as P,B as D,L as V,z as F,M as A,N as B,O,P as $,Q as q}from"./index-C2FMqJ1N.js";import{C as j,a as z,b as H,d as p}from"./card-Cp0xe702.js";import{u as J}from"./ratingsStore-C4jqnmpI.js";import{S as Q,R as G}from"./RatingDisplay-RaKCUACg.js";import{u as K}from"./useRatingConfigs-BjLvN2tB.js";import"./ratingConfigService-CpaQljqG.js";import"./badge-rMA5ZzkR.js";import"./progress-BEkle0Qu.js";import"./calendar-DRJpAVSc.js";import"./ratingConfigsStore-BBTVlzsj.js";import"./filtersStore-CymZsb_f.js";const U=c=>{const{taskRatings:d,taskRatingConfigs:h,taskRatingsPagination:o,isLoading:r,error:m,fetchTaskRatings:g,fetchTaskRatingConfigs:i,createTaskRating:x,updateTaskRating:u}=J(),t=typeof c=="string"?parseInt(c):c;return l.useEffect(()=>{t&&(g(t),i())},[t,g,i]),{taskRatings:d,taskRatingConfigs:h,pagination:o,isLoading:r,error:m,createRating:n=>x({...n,task_id:t}),updateRating:(n,f)=>u(n,f),refreshRatings:()=>g(t)}},W=({taskId:c,config:d,onSubmit:h,isLoading:o})=>{const r=d.config_data,m=l.useMemo(()=>(r.fields||[]).reduce((s,a)=>(s[a.name]=0,s),{}),[r.fields]),g=l.useMemo(()=>{const s={};for(const a of r.fields||[])s[a.name]=k().min(0,{message:"Value must be at least 0"}).max(a.max_value,{message:`Max is ${a.max_value}`});return C({rating_data:C(s)})},[r.fields]),i=_({resolver:S(g),defaultValues:{rating_data:m}});l.useEffect(()=>{i.reset({rating_data:m})},[d.id]);const x=async s=>{const a={task_id:c,rating_config_id:d.id,rating_data:s.rating_data};await h(a)},u=i.watch("rating_data"),t=Object.values(u||{}).reduce((s,a)=>s+(a||0),0),n=(r.fields||[]).reduce((s,a)=>s+a.max_value,0),f=n>0?Math.round(t/n*100):0;return e.jsxs(j,{className:"bg-card border-border",children:[e.jsx(z,{children:e.jsxs(H,{className:"text-foreground flex items-center gap-2",children:[e.jsx(y,{className:"w-5 h-5"}),"Task Rating - ",d.name]})}),e.jsx(p,{children:e.jsx(w,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(x),className:"space-y-6",children:[e.jsx("div",{className:"space-y-6",children:(r.fields||[]).map(s=>e.jsx("div",{children:e.jsx(T,{name:`rating_data.${s.name}`,control:i.control,render:({field:a,fieldState:b})=>e.jsxs(I,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(M,{className:"text-foreground",children:s.name}),s.description&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s.description})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[Number.isFinite(a.value)?a.value:0," / ",s.max_value]})]}),e.jsx(E,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(Q,{value:[Number(a.value??0)],onValueChange:N=>a.onChange(N[0]),max:s.max_value,step:1,className:"flex-1",disabled:o}),e.jsx(L,{type:"number",min:0,max:s.max_value,value:a.value??0,onChange:N=>{const v=N.target.value,R=v===""?0:Number(v);a.onChange(Number.isNaN(R)?0:R)},disabled:o,className:"w-24 text-center"})]})}),b.error&&e.jsx(P,{className:"text-destructive",children:b.error.message})]})})},s.name))}),e.jsx("div",{className:"p-4 bg-accent/20 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Total Rating"}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl font-bold text-foreground",children:[f,"%"]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[t," / ",n]})]})]})}),e.jsxs(D,{type:"submit",disabled:o,className:"w-full bg-primary text-primary-foreground hover:bg-primary/90",children:[o&&e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Submit Rating"]})]})})})]})},de=()=>{const{taskId:c}=F(),{taskRatings:d,isLoading:h,createRating:o}=U(c),{ratingConfigs:r,isLoading:m,error:g,fetchActiveRatingConfigsByType:i}=K(),[x,u]=l.useState(null);l.useEffect(()=>{i("task_rating").then(()=>{})},[c,i]);const t=l.useMemo(()=>r,[r]);l.useEffect(()=>{t?.length?u(s=>s??t[0].id):u(null)},[t]);const n=l.useMemo(()=>t.find(s=>s.id===x)??null,[t,x]),f=async s=>{await o(s)};return c?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(y,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground font-sans",children:"Task Ratings"}),e.jsx("p",{className:"text-muted-foreground",children:"Rate task performance and quality"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(j,{className:"bg-card border-border",children:e.jsxs(p,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Config"}),e.jsx("p",{className:"text-base font-medium truncate",children:n?n.name:"â€”"})]}),e.jsx("div",{className:"w-64",children:e.jsxs(A,{disabled:m||t.length===0,value:x?.toString()??void 0,onValueChange:s=>u(Number(s)),children:[e.jsx(B,{children:e.jsx(O,{placeholder:m?"Loading configs...":"Choose config"})}),e.jsx($,{children:t.map(s=>e.jsx(q,{value:s.id.toString(),children:s.name},s.id))})]})})]}),g&&e.jsx("p",{className:"mt-2 text-sm text-destructive",children:String(g)})]})}),m?e.jsx("div",{className:"h-72 bg-muted animate-pulse rounded-lg"}):t.length===0?e.jsx(j,{className:"bg-card border-border",children:e.jsx(p,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No active task rating configuration found"})})}):n?e.jsx(W,{taskId:parseInt(c),config:n,onSubmit:f,isLoading:h}):e.jsx(j,{className:"bg-card border-border",children:e.jsx(p,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Select a configuration to start rating"})})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Previous Ratings"}),h?e.jsx("div",{className:"space-y-4",children:Array.from({length:3}).map((s,a)=>e.jsx("div",{className:"h-32 bg-muted animate-pulse rounded-lg"},a))}):d.length===0?e.jsx(j,{className:"bg-card border-border",children:e.jsx(p,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No ratings yet for this task"})})}):e.jsx("div",{className:"space-y-4",children:d.map(s=>e.jsx(G,{rating:s},s.id))})]})]})]}):e.jsx("div",{children:"Task not found"})};export{de as default};
