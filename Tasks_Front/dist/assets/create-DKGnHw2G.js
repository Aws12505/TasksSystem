import{r as _,a6 as ee,a4 as se,a as ae,b as te,o as T,ak as q,G as ie,j as e,I as c,$ as I,K as x,M as j,N as p,O as g,P as n,B as l,af as D,U as re,al as E,ah as b,ag as F,s as m,A as ne,am as le,a1 as de,x as ce,S as me}from"./index-BIXuByyq.js";import{C as A,a as P,b as V,d as U}from"./card-DXKjgZZu.js";import{L as oe}from"./list-BSjonm06.js";import{P as z}from"./plus-Dd03PpEI.js";import{A as ue}from"./arrow-left-DLDBHto6.js";const he=T({name:m().min(1,"Task name is required").max(255),description:m().optional(),weight:b().min(1).max(100),due_date:m().min(1,"Due date is required"),priority:F(["low","medium","high","critical"]),project_id:b().min(1,"Project is required"),section_id:b().min(1,"Section is required"),subtasks:E(T({name:m().min(1,"Subtask name is required"),description:m().optional(),due_date:m().min(1,"Due date is required"),priority:F(["low","medium","high","critical"])})).optional(),assignments:E(T({user_id:b().min(1,"User is required"),percentage:b().min(.01).max(100)})).optional()}),xe=({sectionId:v,onSubmit:k,onCancel:o,isLoading:t})=>{const[f,y]=_.useState([]),{projects:w,fetchProjects:N,isLoading:B}=ee(),{sections:M,fetchSectionsByProject:H,isLoading:G}=se(),a=ae({resolver:te(he),defaultValues:{name:"",description:"",weight:10,due_date:"",priority:"medium",project_id:0,section_id:v||0,subtasks:[],assignments:[]}}),{fields:S,append:K,remove:O}=q({control:a.control,name:"subtasks"}),{fields:C,append:R,remove:W}=q({control:a.control,name:"assignments"}),d=a.watch("project_id"),$=a.watch("assignments")||[];_.useEffect(()=>{N(),X()},[]),_.useEffect(()=>{d&&d>0&&(H(d),v||a.setValue("section_id",0))},[d]);const X=async()=>{try{const s=await ie.getUsers(1,100);s.success&&s.data&&y(s.data)}catch(s){console.error("Failed to fetch users:",s)}},J=async s=>{const{project_id:i,...r}=s,L={...r,weight:Number(r.weight),section_id:Number(r.section_id),subtasks:r.subtasks?.map(h=>({...h,due_date:h.due_date}))||[],assignments:r.assignments?.map(h=>({user_id:Number(h.user_id),percentage:Number(h.percentage)}))||[]};await k(L)},Q=M.filter(s=>s.project_id===d),Y=$.map(s=>s.user_id),Z=f.filter(s=>!Y.includes(s.id)),u=$.reduce((s,i)=>s+(Number(i.percentage)||0),0);return e.jsx("div",{className:"space-y-6",children:e.jsxs("form",{onSubmit:a.handleSubmit(J),className:"space-y-6",children:[e.jsxs(A,{children:[e.jsx(P,{children:e.jsx(V,{children:"Task Information"})}),e.jsxs(U,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Task Name *"}),e.jsx(c,{...a.register("name"),placeholder:"Enter task name",disabled:t}),a.formState.errors.name&&e.jsx("p",{className:"text-sm text-red-500",children:a.formState.errors.name.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Weight *"}),e.jsx(c,{type:"number",...a.register("weight",{valueAsNumber:!0}),min:"1",max:"100",disabled:t})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description"}),e.jsx(I,{...a.register("description"),placeholder:"Enter task description",disabled:t,rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Due Date *"}),e.jsx(c,{type:"date",...a.register("due_date"),disabled:t})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Priority *"}),e.jsxs(x,{value:a.watch("priority"),onValueChange:s=>a.setValue("priority",s),disabled:t,children:[e.jsx(j,{children:e.jsx(p,{})}),e.jsxs(g,{children:[e.jsx(n,{value:"low",children:"Low"}),e.jsx(n,{value:"medium",children:"Medium"}),e.jsx(n,{value:"high",children:"High"}),e.jsx(n,{value:"critical",children:"Critical"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Project *"}),e.jsxs(x,{value:a.watch("project_id")?.toString()||"",onValueChange:s=>a.setValue("project_id",Number(s)),disabled:t||B,children:[e.jsx(j,{children:e.jsx(p,{placeholder:"Select project"})}),e.jsx(g,{children:w.map(s=>e.jsx(n,{value:s.id.toString(),children:s.name},s.id))})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Section *"}),e.jsxs(x,{value:a.watch("section_id")?.toString()||"",onValueChange:s=>a.setValue("section_id",Number(s)),disabled:t||G||!d,children:[e.jsx(j,{children:e.jsx(p,{placeholder:"Select section"})}),e.jsx(g,{children:Q.map(s=>e.jsx(n,{value:s.id.toString(),children:s.name},s.id))})]})]})]})]}),e.jsxs(A,{children:[e.jsxs(P,{className:"flex flex-row items-center justify-between",children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5"}),"Subtasks (",S.length,")"]}),e.jsxs(l,{type:"button",variant:"outline",size:"sm",onClick:()=>K({name:"",description:"",due_date:"",priority:"medium"}),disabled:t,children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Add Subtask"]})]}),e.jsxs(U,{className:"space-y-4",children:[S.map((s,i)=>e.jsxs("div",{className:"p-4 border rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"font-medium",children:["Subtask ",i+1]}),e.jsx(l,{type:"button",variant:"ghost",size:"sm",onClick:()=>O(i),disabled:t,children:e.jsx(D,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx("div",{children:e.jsx(c,{...a.register(`subtasks.${i}.name`),placeholder:"Subtask name",disabled:t})}),e.jsx("div",{children:e.jsx(c,{type:"date",...a.register(`subtasks.${i}.due_date`),disabled:t})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx("div",{children:e.jsx(I,{...a.register(`subtasks.${i}.description`),placeholder:"Subtask description",disabled:t,rows:2})}),e.jsx("div",{children:e.jsxs(x,{value:a.watch(`subtasks.${i}.priority`),onValueChange:r=>a.setValue(`subtasks.${i}.priority`,r),disabled:t,children:[e.jsx(j,{children:e.jsx(p,{})}),e.jsxs(g,{children:[e.jsx(n,{value:"low",children:"Low"}),e.jsx(n,{value:"medium",children:"Medium"}),e.jsx(n,{value:"high",children:"High"}),e.jsx(n,{value:"critical",children:"Critical"})]})]})})]})]},s.id)),S.length===0&&e.jsx("p",{className:"text-muted-foreground text-center py-8",children:'No subtasks added yet. Click "Add Subtask" to create one.'})]})]}),e.jsxs(A,{children:[e.jsxs(P,{className:"flex flex-row items-center justify-between",children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-5 h-5"}),"User Assignments (",C.length,")",e.jsxs("span",{className:"text-sm font-normal",children:[u,"% assigned"]})]}),e.jsxs(l,{type:"button",variant:"outline",size:"sm",onClick:()=>R({user_id:0,percentage:10}),disabled:t||Z.length===0||u>=100,children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Assign User"]})]}),e.jsxs(U,{className:"space-y-4",children:[e.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full transition-all duration-300",style:{width:`${Math.min(u,100)}%`}})}),C.map((s,i)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg",children:[e.jsx("div",{className:"flex-1",children:e.jsxs(x,{value:a.watch(`assignments.${i}.user_id`)?.toString()||"",onValueChange:r=>a.setValue(`assignments.${i}.user_id`,Number(r)),disabled:t,children:[e.jsx(j,{children:e.jsx(p,{placeholder:"Select user"})}),e.jsx(g,{children:f.map(r=>e.jsx(n,{value:r.id.toString(),children:r.name},r.id))})]})}),e.jsx("div",{className:"w-24",children:e.jsx(c,{type:"number",...a.register(`assignments.${i}.percentage`,{valueAsNumber:!0}),placeholder:"%",min:"0.01",max:"100",step:"0.01",disabled:t})}),e.jsx(l,{type:"button",variant:"ghost",size:"sm",onClick:()=>W(i),disabled:t,children:e.jsx(D,{className:"w-4 h-4"})})]},s.id)),C.length===0&&e.jsx("p",{className:"text-muted-foreground text-center py-8",children:'No users assigned yet. Click "Assign User" to add assignments.'}),u>100&&e.jsx("p",{className:"text-sm text-red-500",children:"Total assignment percentage cannot exceed 100%"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(l,{type:"submit",disabled:t||u>100,className:"bg-primary text-primary-foreground hover:bg-primary/90",children:[t&&e.jsx("div",{className:"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-b-transparent"}),"Create Task with Everything"]}),o&&e.jsx(l,{type:"button",variant:"outline",onClick:o,disabled:t,children:"Cancel"})]})]})})},fe=()=>{const v=ne(),[k]=le(),o=k.get("section_id"),{createTaskComprehensive:t,isLoading:f}=de(),y=async w=>{const N=await t(w);N&&v(`/tasks/${N.id}`)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(l,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(ce,{to:"/tasks",children:[e.jsx(ue,{className:"mr-2 h-4 w-4"}),"Back to Tasks"]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(me,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground font-sans",children:"Create Comprehensive Task"}),e.jsx("p",{className:"text-muted-foreground",children:"Create a task with subtasks and user assignments"})]})]})]}),e.jsx("div",{className:"max-w-4xl",children:e.jsx(xe,{sectionId:o?parseInt(o):void 0,onSubmit:y,isLoading:f})})]})};export{fe as default};
