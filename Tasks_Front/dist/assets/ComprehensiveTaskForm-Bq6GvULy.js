import{r as _,a5 as re,W as ae,a as ie,b as ne,o as U,ar as z,j as e,I as o,Q as M,K as j,M as g,N as b,O as f,P as d,B as h,al as W,U as ce,as as B,an as u,am as I,s as x,E as R,G as de}from"./index-aIDF15FF.js";import{C as P,a as A,b as E,d as T}from"./card-DegwiSso.js";import{L as me}from"./list-xt-7shSL.js";import{P as H}from"./plus-DsrYCZRf.js";const le=U({id:u().optional(),name:x().min(1,"Subtask name is required"),description:x().optional().or(R("")),due_date:x().min(1,"Due date is required"),priority:I(["low","medium","high","critical"])}),oe=U({user_id:u().min(1,"User is required"),percentage:u().min(.01,"Percentage must be greater than 0").max(100)}),he=U({name:x().min(1,"Task name is required").max(255),description:x().optional().or(R("")),weight:u().min(1,"Weight must be at least 1").max(100,"Weight cannot exceed 100"),due_date:x().min(1,"Due date is required"),priority:I(["low","medium","high","critical"]),project_id:u().min(1,"Project is required"),section_id:u().min(1,"Section is required"),subtasks:B(le).optional(),assignments:B(oe).min(1,"At least one assignment is required")}),ge=({mode:N="create",sectionId:m,initialValues:a,onSubmit:G,onCancel:q,isLoading:i})=>{const[F,K]=_.useState([]),{projects:S,fetchProjects:O,isLoading:Q}=re(),{sections:$,fetchSectionsByProject:v,isLoading:D}=ae(),s=ie({resolver:ne(he),defaultValues:{name:a?.name||"",description:a?.description||"",weight:a?.weight||10,due_date:a?.due_date||"",priority:a?.priority||"medium",project_id:a?.project_id||(S.length>0?S[0].id:void 0),section_id:m||a?.section_id||void 0,subtasks:a?.subtasks||[],assignments:a?.assignments||[]}});_.useEffect(()=>{a&&s.reset({name:a.name||"",description:a.description||"",weight:a.weight||10,due_date:a.due_date||"",priority:a.priority||"medium",project_id:a.project_id,section_id:m||a.section_id,subtasks:a.subtasks||[],assignments:a.assignments||[]})},[a,m,s]);const{fields:y,append:X,remove:J}=z({control:s.control,name:"subtasks"}),{fields:w,append:Y,remove:Z}=z({control:s.control,name:"assignments"}),l=s.watch("project_id"),k=s.watch("assignments")||[];_.useEffect(()=>{(async()=>{if(await O(),await V(),a?.project_id)await v(a.project_id);else if(m){const r=$.find(n=>n.id===m);r?.project_id&&(await v(r.project_id),s.setValue("project_id",r.project_id))}})()},[]),_.useEffect(()=>{l&&l>0&&(v(l),!m&&N==="create"&&s.setValue("section_id",void 0))},[l,v,m,N,s]);const V=async()=>{try{const t=await de.getUsers(1,100);t.success&&t.data&&K(t.data)}catch(t){console.error("Failed to fetch users:",t)}},L=async t=>{if(console.log("Raw form data:",t),!t.section_id||t.section_id<=0){s.setError("section_id",{message:"Please select a section"});return}if(!t.assignments||t.assignments.length===0){s.setError("assignments",{message:"At least one user assignment is required"});return}if(t.assignments.reduce((c,te)=>c+Number(te.percentage),0)>100){s.setError("assignments",{message:"Total assignment percentage cannot exceed 100%"});return}const n={name:t.name.trim(),description:t.description?.trim()||"",weight:Number(t.weight),due_date:t.due_date,priority:t.priority,project_id:Number(t.project_id),section_id:Number(t.section_id),subtasks:(t.subtasks||[]).map(c=>({...c,name:c.name.trim(),description:c.description?.trim()||"",due_date:c.due_date})),assignments:t.assignments.map(c=>({user_id:Number(c.user_id),percentage:Number(c.percentage)}))};console.log("Formatted data for API:",n);try{await G(n)}catch(c){console.error("Form submission error:",c)}},C=$.filter(t=>t.project_id===l),ee=k.map(t=>Number(t.user_id)).filter(t=>t>0),se=F.filter(t=>!ee.includes(t.id)),p=k.reduce((t,r)=>t+(Number(r.percentage)||0),0);return e.jsx("div",{className:"space-y-6",children:e.jsxs("form",{onSubmit:s.handleSubmit(L),className:"space-y-6",children:[e.jsxs(P,{children:[e.jsx(A,{children:e.jsx(E,{children:N==="edit"?"Edit Task":"Task Information"})}),e.jsxs(T,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Task Name *"}),e.jsx(o,{...s.register("name"),placeholder:"Enter task name",disabled:i}),s.formState.errors.name&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:s.formState.errors.name.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Weight *"}),e.jsx(o,{type:"number",...s.register("weight",{valueAsNumber:!0}),min:"1",max:"100",disabled:i}),s.formState.errors.weight&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:s.formState.errors.weight.message})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description"}),e.jsx(M,{...s.register("description"),placeholder:"Enter task description",disabled:i,rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Due Date *"}),e.jsx(o,{type:"date",...s.register("due_date"),disabled:i}),s.formState.errors.due_date&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:s.formState.errors.due_date.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Priority *"}),e.jsxs(j,{value:s.watch("priority"),onValueChange:t=>s.setValue("priority",t),disabled:i,children:[e.jsx(g,{children:e.jsx(b,{})}),e.jsxs(f,{children:[e.jsx(d,{value:"low",children:"Low"}),e.jsx(d,{value:"medium",children:"Medium"}),e.jsx(d,{value:"high",children:"High"}),e.jsx(d,{value:"critical",children:"Critical"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Project *"}),e.jsxs(j,{value:s.watch("project_id")?.toString()||"",onValueChange:t=>s.setValue("project_id",Number(t)),disabled:i||Q,children:[e.jsx(g,{children:e.jsx(b,{placeholder:"Select project"})}),e.jsx(f,{children:S.map(t=>e.jsx(d,{value:t.id.toString(),children:t.name},t.id))})]}),s.formState.errors.project_id&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:s.formState.errors.project_id.message})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Section *"}),e.jsxs(j,{value:s.watch("section_id")?.toString()||"",onValueChange:t=>s.setValue("section_id",Number(t)),disabled:i||D||!l||C.length===0,children:[e.jsx(g,{children:e.jsx(b,{placeholder:"Select section"})}),e.jsx(f,{children:C.map(t=>e.jsx(d,{value:t.id.toString(),children:t.name},t.id))})]}),s.formState.errors.section_id&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:s.formState.errors.section_id.message}),l&&C.length===0&&!D&&e.jsx("p",{className:"text-sm text-amber-600 mt-1",children:"No sections available for this project"})]})]})]}),e.jsxs(P,{children:[e.jsxs(A,{className:"flex flex-row items-center justify-between",children:[e.jsxs(E,{className:"flex items-center gap-2",children:[e.jsx(me,{className:"w-5 h-5"}),"Subtasks (",y.length,")"]}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:()=>X({name:"",description:"",due_date:"",priority:"medium"}),disabled:i,children:[e.jsx(H,{className:"w-4 h-4 mr-2"})," Add Subtask"]})]}),e.jsxs(T,{className:"space-y-4",children:[y.map((t,r)=>e.jsxs("div",{className:"p-4 border rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"font-medium",children:["Subtask ",r+1]}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",onClick:()=>J(r),disabled:i,children:e.jsx(W,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(o,{...s.register(`subtasks.${r}.name`),placeholder:"Subtask name",disabled:i}),s.formState.errors.subtasks?.[r]?.name&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:s.formState.errors.subtasks[r]?.name?.message})]}),e.jsxs("div",{children:[e.jsx(o,{type:"date",...s.register(`subtasks.${r}.due_date`),disabled:i}),s.formState.errors.subtasks?.[r]?.due_date&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:s.formState.errors.subtasks[r]?.due_date?.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(M,{...s.register(`subtasks.${r}.description`),placeholder:"Subtask description (optional)",disabled:i,rows:2}),e.jsxs(j,{value:s.watch(`subtasks.${r}.priority`)||"medium",onValueChange:n=>s.setValue(`subtasks.${r}.priority`,n),disabled:i,children:[e.jsx(g,{children:e.jsx(b,{})}),e.jsxs(f,{children:[e.jsx(d,{value:"low",children:"Low"}),e.jsx(d,{value:"medium",children:"Medium"}),e.jsx(d,{value:"high",children:"High"}),e.jsx(d,{value:"critical",children:"Critical"})]})]})]})]},t.id)),y.length===0&&e.jsx("p",{className:"text-muted-foreground text-center py-8",children:'No subtasks added yet. Click "Add Subtask" to create one.'})]})]}),e.jsxs(P,{children:[e.jsxs(A,{className:"flex flex-row items-center justify-between",children:[e.jsxs(E,{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5"}),"User Assignments (",w.length,")",e.jsxs("span",{className:"text-sm font-normal",children:[p.toFixed(1),"% assigned"]})]}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:()=>Y({user_id:0,percentage:10}),disabled:i||se.length===0||p>=100,children:[e.jsx(H,{className:"w-4 h-4 mr-2"})," Assign User"]})]}),e.jsxs(T,{className:"space-y-4",children:[s.formState.errors.assignments&&e.jsx("p",{className:"text-sm text-red-500",children:s.formState.errors.assignments.message}),e.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full transition-all duration-300",style:{width:`${Math.min(p,100)}%`}})}),w.map((t,r)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs(j,{value:s.watch(`assignments.${r}.user_id`)?.toString()||"",onValueChange:n=>s.setValue(`assignments.${r}.user_id`,Number(n)),disabled:i,children:[e.jsx(g,{children:e.jsx(b,{placeholder:"Select user"})}),e.jsx(f,{children:F.map(n=>e.jsx(d,{value:n.id.toString(),children:n.name},n.id))})]}),s.formState.errors.assignments?.[r]?.user_id&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:s.formState.errors.assignments[r]?.user_id?.message})]}),e.jsxs("div",{className:"w-24",children:[e.jsx(o,{type:"number",...s.register(`assignments.${r}.percentage`,{valueAsNumber:!0}),placeholder:"%",min:"0.01",max:"100",step:"0.01",disabled:i}),s.formState.errors.assignments?.[r]?.percentage&&e.jsx("p",{className:"text-sm text-red-500 mt-1",children:s.formState.errors.assignments[r]?.percentage?.message})]}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",onClick:()=>Z(r),disabled:i,children:e.jsx(W,{className:"w-4 h-4"})})]},t.id)),w.length===0&&e.jsx("p",{className:"text-muted-foreground text-center py-8",children:'No users assigned yet. Click "Assign User" to add assignments.'}),p>100&&e.jsx("p",{className:"text-sm text-red-500",children:"Total assignment percentage cannot exceed 100%"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{type:"submit",disabled:i||p>100||k.length===0||!s.watch("section_id")||!s.watch("name")?.trim(),className:"bg-primary text-primary-foreground hover:bg-primary/90",children:N==="edit"?"Save Changes":"Create Task with Everything"}),q&&e.jsx(h,{type:"button",variant:"outline",onClick:q,disabled:i,children:"Cancel"})]})]})})};export{ge as C};
