import{v as i,w as m,x as t,Q as u,R as c}from"./index-B85HOyWI.js";class g{async me(){return i.get("/me")}async updateProfile(a){const e=new FormData;return a.name&&e.append("name",a.name),a.email&&e.append("email",a.email),a.avatar&&e.append("avatar",a.avatar),i.postMultipart("/profile",e)}async updatePassword(a){return i.post("/profile/password",a)}}const d=new g,n=m(s=>({me:null,loading:!1,error:null,fetchMe:async()=>{s({loading:!0,error:null});try{const a=await d.me();if(a.success){const e=a.data;s({me:e,loading:!1});const r=P(e);u.setState({user:e,allPermissions:r,isAuthenticated:!0})}else s({error:a.message,loading:!1}),t.error(a.message)}catch(a){s({error:a.message||"Failed to load profile",loading:!1}),t.error(a.message||"Failed to load profile")}},updateProfile:async a=>{s({loading:!0,error:null});try{const e=await d.updateProfile(a);if(e.success){const r=e.data;return s({me:r,loading:!1}),u.setState({user:r}),t.success("Profile updated"),r}else return s({error:e.message,loading:!1}),t.error(e.message),null}catch(e){return s({error:e.message||"Failed to update profile",loading:!1}),t.error(e.message||"Failed to update profile"),null}},updatePassword:async a=>{s({loading:!0,error:null});try{const e=await d.updatePassword(a);return s({loading:!1}),e.success?(t.success("Password updated"),!0):(t.error(e.message),!1)}catch(e){return s({loading:!1,error:e.message||"Failed to update password"}),t.error(e.message||"Failed to update password"),!1}}})),P=s=>{if(!s)return[];const a=[],e=new Set;return s.permissions&&s.permissions.forEach(r=>{e.has(r.name)||(a.push(r),e.add(r.name))}),s.roles&&s.roles.forEach(r=>{r.permissions&&r.permissions.forEach(l=>{e.has(l.name)||(a.push(l),e.add(l.name))})}),a},h=()=>{const s=n(o=>o.me),a=n(o=>o.loading),e=n(o=>o.fetchMe),r=n(o=>o.updateProfile),l=n(o=>o.updatePassword);c.useEffect(()=>{s||e()},[s,e]);const f=c.useCallback(o=>r(o),[r]),p=c.useCallback(o=>l(o),[l]);return{me:s,loading:a,fetchMe:e,saveProfile:f,updatePassword:p}};export{h as u};
