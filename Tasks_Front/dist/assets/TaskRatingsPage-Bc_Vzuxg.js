import{r as u,al as w,o as P,a as T,b as I,j as e,n as S,F as M,aK as E,d as L,e as D,f as F,I as V,g as A,B,L as O,z as $,M as q,N as z,O as H,P as K,Q}from"./index-BoroKU0h.js";import{C as v,a as G,b as J,d as b}from"./card-Dihqd1Tq.js";import{P as U,a as W,b as k,c as X,d as Y,e as Z,f as ee}from"./pagination-BYrR7XPa.js";import{u as se}from"./ratingsStore-Bw7XB-jJ.js";import{S as ae,R as te}from"./RatingDisplay-FEairSXe.js";import{u as ne}from"./useRatingConfigs-DSJs6DRH.js";import"./ellipsis-Kn7O6V0g.js";import"./ratingConfigService-Bv-NPdeM.js";import"./badge-B-NgAhQH.js";import"./progress-IEtkPirU.js";import"./calendar-DVQKPfrD.js";import"./ratingConfigsStore-DN8gqUov.js";import"./filtersStore-CcSDRn7W.js";const re=o=>{const{taskRatings:c,taskRatingConfigs:r,taskRatingsPagination:n,isLoading:l,error:f,fetchTaskRatings:h,fetchTaskRatingConfigs:d,createTaskRating:j,updateTaskRating:p}=se(),i=typeof o=="string"?parseInt(o):o;u.useEffect(()=>{i&&!c.length&&(h(i,1),d())},[i,h,d,c.length]);const m=s=>{h(i,s)};return{taskRatings:c,taskRatingConfigs:r,pagination:n,isLoading:l,error:f,createRating:s=>j({...s,task_id:i}),updateRating:(s,x)=>p(s,x),refreshRatings:()=>h(i),goToPage:m,nextPage:()=>{n&&n.current_page<n.last_page&&m(n.current_page+1)},prevPage:()=>{n&&n.current_page>1&&m(n.current_page-1)}}},ie=({taskId:o,config:c,onSubmit:r,isLoading:n})=>{const l=c.config_data,f=u.useMemo(()=>(l.fields||[]).reduce((t,s)=>(t[s.name]=0,t),{}),[l.fields]),h=u.useMemo(()=>{const t={};for(const s of l.fields||[])t[s.name]=w().min(0,{message:"Value must be at least 0"}).max(s.max_value,{message:`Max is ${s.max_value}`});return P({rating_data:P(t)})},[l.fields]),d=T({resolver:I(h),defaultValues:{rating_data:f}});u.useEffect(()=>{d.reset({rating_data:f})},[c.id]);const j=async t=>{const s={task_id:o,rating_config_id:c.id,rating_data:t.rating_data};await r(s)},p=d.watch("rating_data"),i=Object.values(p||{}).reduce((t,s)=>t+(s||0),0),m=(l.fields||[]).reduce((t,s)=>t+s.max_value,0),N=m>0?Math.round(i/m*100):0;return e.jsxs(v,{className:"bg-card border-border",children:[e.jsx(G,{children:e.jsxs(J,{className:"text-foreground flex items-center gap-2",children:[e.jsx(S,{className:"w-5 h-5"}),"Task Rating - ",c.name]})}),e.jsx(b,{children:e.jsx(M,{...d,children:e.jsxs("form",{onSubmit:d.handleSubmit(j),className:"space-y-6",children:[e.jsx("div",{className:"space-y-6",children:(l.fields||[]).map(t=>e.jsx("div",{children:e.jsx(E,{name:`rating_data.${t.name}`,control:d.control,render:({field:s,fieldState:x})=>e.jsxs(L,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(D,{className:"text-foreground",children:t.name}),t.description&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:t.description})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[Number.isFinite(s.value)?s.value:0," / ",t.max_value]})]}),e.jsx(F,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(ae,{value:[Number(s.value??0)],onValueChange:R=>s.onChange(R[0]),max:t.max_value,step:1,className:"flex-1",disabled:n}),e.jsx(V,{type:"number",min:0,max:t.max_value,value:s.value??0,onChange:R=>{const C=R.target.value,a=C===""?0:Number(C);s.onChange(Number.isNaN(a)?0:a)},disabled:n,className:"w-24 text-center"})]})}),x.error&&e.jsx(A,{className:"text-destructive",children:x.error.message})]})})},t.name))}),e.jsx("div",{className:"p-4 bg-accent/20 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Total Rating"}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl font-bold text-foreground",children:[N,"%"]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[i," / ",m]})]})]})}),e.jsxs(B,{type:"submit",disabled:n,className:"w-full bg-primary text-primary-foreground hover:bg-primary/90",children:[n&&e.jsx(O,{className:"mr-2 h-4 w-4 animate-spin"}),"Submit Rating"]})]})})})]})},ve=()=>{const{taskId:o}=$(),{taskRatings:c,pagination:r,isLoading:n,createRating:l,goToPage:f,nextPage:h,prevPage:d}=re(o),{ratingConfigs:j,isLoading:p,error:i,fetchActiveRatingConfigsByType:m}=ne(),[N,t]=u.useState(null);u.useEffect(()=>{m("task_rating").then(()=>{})},[o,m]);const s=u.useMemo(()=>j,[j]);u.useEffect(()=>{s?.length?t(a=>a??s[0].id):t(null)},[s]);const x=u.useMemo(()=>s.find(a=>a.id===N)??null,[s,N]),R=async a=>{await l(a)},C=()=>{if(!r)return[];const a=[],{current_page:g,last_page:_}=r;g>3&&(a.push(1),g>4&&a.push("ellipsis-start"));for(let y=Math.max(1,g-2);y<=Math.min(_,g+2);y++)a.push(y);return g<_-2&&(g<_-3&&a.push("ellipsis-end"),a.push(_)),a};return o?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(S,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground font-sans",children:"Task Ratings"}),e.jsx("p",{className:"text-muted-foreground",children:"Rate task performance and quality"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(v,{className:"bg-card border-border",children:e.jsxs(b,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Config"}),e.jsx("p",{className:"text-base font-medium truncate",children:x?x.name:"â€”"})]}),e.jsx("div",{className:"w-64",children:e.jsxs(q,{disabled:p||s.length===0,value:N?.toString()??void 0,onValueChange:a=>t(Number(a)),children:[e.jsx(z,{children:e.jsx(H,{placeholder:p?"Loading configs...":"Choose config"})}),e.jsx(K,{children:s.map(a=>e.jsx(Q,{value:a.id.toString(),children:a.name},a.id))})]})})]}),i&&e.jsx("p",{className:"mt-2 text-sm text-destructive",children:String(i)})]})}),p?e.jsx("div",{className:"h-72 bg-muted animate-pulse rounded-lg"}):s.length===0?e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No active task rating configuration found"})})}):x?e.jsx(ie,{taskId:parseInt(o),config:x,onSubmit:R,isLoading:n}):e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Select a configuration to start rating"})})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Previous Ratings"}),n?e.jsx("div",{className:"space-y-4",children:Array.from({length:3}).map((a,g)=>e.jsx("div",{className:"h-32 bg-muted animate-pulse rounded-lg"},g))}):c.length===0?e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No ratings yet for this task"})})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-4",children:c.map(a=>e.jsx(te,{rating:a},a.id))}),r&&r.last_page>1&&e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",r.from||0," to ",r.to||0," of ",r.total," results"]}),e.jsx(U,{children:e.jsxs(W,{children:[e.jsx(k,{children:e.jsx(X,{onClick:d,className:r.current_page===1?"pointer-events-none opacity-50":"cursor-pointer"})}),C().map((a,g)=>e.jsx(k,{children:a==="ellipsis-start"||a==="ellipsis-end"?e.jsx(Y,{}):e.jsx(Z,{onClick:()=>f(a),isActive:r.current_page===a,className:"cursor-pointer",children:a})},g)),e.jsx(k,{children:e.jsx(ee,{onClick:h,className:r.current_page===r.last_page?"pointer-events-none opacity-50":"cursor-pointer"})})]})})]})})})]})]})]})]}):e.jsx("div",{children:"Task not found"})};export{ve as default};
