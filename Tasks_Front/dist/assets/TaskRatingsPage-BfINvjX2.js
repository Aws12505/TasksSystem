import{R as u,aN as E,o as T,a as A,b as $,j as e,C as v,c as D,d as F,S,f as b,aZ as V,I as B,B as L,L as U,a0 as W,Z as O,U as Z,K as q,M as z,N as H,O as K,P as G}from"./index-BAxnQz6X.js";import{P as J,a as Q,b as w,c as X,d as Y,e as ee,f as se}from"./pagination-_ftPBJbC.js";import{u as ae}from"./ratingsStore-B_KehZ-M.js";import{F as te,b as ne,c as re,d as ie,e as ce}from"./form-DlMgMJR5.js";import{S as le,R as de}from"./RatingDisplay-B6nXYI_w.js";import{u as oe}from"./useRatingConfigs-B0pROgl4.js";import{u as me}from"./useTask-BEaVyiBR.js";import{A as ge}from"./arrow-left-D_pQe2Bh.js";import{W as xe}from"./weight-dc5N_czy.js";import"./ellipsis-J8UwU12e.js";import"./ratingConfigService-hdbywE6l.js";import"./label-ClF9N7dm.js";import"./badge-BQPkPnbY.js";import"./progress-DBcLPpj1.js";import"./user-_dc176PQ.js";import"./ratingConfigsStore-Bx2PTcve.js";import"./filtersStore-DF5zeNFh.js";const ue=c=>{const{taskRatings:r,taskRatingConfigs:y,taskRatingsPagination:n,isLoading:l,error:i,fetchTaskRatings:h,fetchTaskRatingConfigs:m,createTaskRating:R,updateTaskRating:k}=ae(),d=typeof c=="string"?parseInt(c):c;u.useEffect(()=>{d&&!r.length&&(h(d,1),m())},[d,h,m,r.length]);const g=a=>{h(d,a)};return{taskRatings:r,taskRatingConfigs:y,pagination:n,isLoading:l,error:i,createRating:a=>R({...a,task_id:d}),updateRating:(a,p)=>k(a,p),refreshRatings:()=>h(d),goToPage:g,nextPage:()=>{n&&n.current_page<n.last_page&&g(n.current_page+1)},prevPage:()=>{n&&n.current_page>1&&g(n.current_page-1)}}},he=({taskId:c,config:r,onSubmit:y,isLoading:n})=>{const l=r.config_data,i=u.useMemo(()=>(l.fields||[]).reduce((t,a)=>(t[a.name]=0,t),{}),[l.fields]),h=u.useMemo(()=>{const t={};for(const a of l.fields||[])t[a.name]=E().min(0,{message:"Value must be at least 0"}).max(a.max_value,{message:`Max is ${a.max_value}`});return T({rating_data:T(t)})},[l.fields]),m=A({resolver:$(h),defaultValues:{rating_data:i}});u.useEffect(()=>{m.reset({rating_data:i})},[r.id]);const R=async t=>{const a={task_id:c,rating_config_id:r.id,rating_data:t.rating_data};await y(a)},k=m.watch("rating_data"),d=Object.values(k||{}).reduce((t,a)=>t+(a||0),0),g=(l.fields||[]).reduce((t,a)=>t+a.max_value,0),f=g>0?Math.round(d/g*100):0;return e.jsxs(v,{className:"bg-card border-border",children:[e.jsx(D,{children:e.jsxs(F,{className:"text-foreground flex items-center gap-2",children:[e.jsx(S,{className:"w-5 h-5"}),"Task Rating - ",r.name]})}),e.jsx(b,{children:e.jsx(te,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(R),className:"space-y-6",children:[e.jsx("div",{className:"space-y-6",children:(l.fields||[]).map(t=>e.jsx("div",{children:e.jsx(V,{name:`rating_data.${t.name}`,control:m.control,render:({field:a,fieldState:p})=>e.jsxs(ne,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(re,{className:"text-foreground",children:t.name}),t.description&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:t.description})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[Number.isFinite(a.value)?a.value:0," / ",t.max_value]})]}),e.jsx(ie,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(le,{value:[Number(a.value??0)],onValueChange:j=>a.onChange(j[0]),max:t.max_value,step:1,className:"flex-1",disabled:n}),e.jsx(B,{type:"number",min:0,max:t.max_value,value:a.value??0,onChange:j=>{const o=j.target.value,N=o===""?0:Number(o);a.onChange(Number.isNaN(N)?0:N)},disabled:n,className:"w-24 text-center"})]})}),p.error&&e.jsx(ce,{className:"text-destructive",children:p.error.message})]})})},t.name))}),e.jsx("div",{className:"p-4 bg-accent/20 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Total Rating"}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl font-bold text-foreground",children:[f,"%"]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[d," / ",g]})]})]})}),e.jsxs(L,{type:"submit",disabled:n,className:"w-full bg-primary text-primary-foreground hover:bg-primary/90",children:[n&&e.jsx(U,{className:"mr-2 h-4 w-4 animate-spin"}),"Submit Rating"]})]})})})]})},Me=()=>{const{taskId:c}=W();if(!c)return e.jsx("div",{children:"Task not found"});const{task:r,taskWithAssignments:y,isLoading:n}=me(c);u.useEffect(()=>{document.title=r?.name?`Task Ratings — ${r.name}`:"Task Ratings"},[r?.name]);const{taskRatings:l,pagination:i,isLoading:h,createRating:m,goToPage:R,nextPage:k,prevPage:d}=ue(c),{ratingConfigs:g,isLoading:f,error:t,fetchActiveRatingConfigsByType:a}=oe(),[p,j]=u.useState(null);u.useEffect(()=>{a("task_rating")},[c,a]);const o=u.useMemo(()=>g,[g]);u.useEffect(()=>{o?.length?j(s=>s??o[0].id):j(null)},[o]);const N=u.useMemo(()=>o.find(s=>s.id===p)??null,[o,p]),I=async s=>{await m(s)},M=()=>{if(!i)return[];const s=[],{current_page:x,last_page:C}=i;x>3&&(s.push(1),x>4&&s.push("ellipsis-start"));for(let _=Math.max(1,x-2);_<=Math.min(C,x+2);_++)s.push(_);return x<C-2&&(x<C-3&&s.push("ellipsis-end"),s.push(C)),s},P=y?.assigned_users??[];return e.jsx("div",{className:"min-h-screen flex flex-col",children:e.jsxs("div",{className:"flex-1 space-y-6 p-4 md:p-6 max-w-full",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(S,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-3xl font-bold text-foreground font-sans truncate",children:["Task Ratings",r?.name?` — ${r.name}`:""]}),e.jsx("p",{className:"text-muted-foreground",children:"Rate task performance and quality"})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(L,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs(O,{to:`/tasks/${c}`,children:[e.jsx(ge,{className:"mr-2 h-4 w-4"}),"Back to Task"]})})})]}),e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-1 min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Task"}),e.jsx("p",{className:"font-medium truncate",children:n?"Loading…":r?.name??"—"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),"Weight"]}),e.jsx("p",{className:"font-medium",children:n?"Loading…":r?.weight??"—"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4"}),"Assigned Users"]}),n?e.jsx("div",{className:"h-10 bg-muted animate-pulse rounded-lg"}):P.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No assigned users"}):e.jsx("div",{className:"space-y-2",children:e.jsx("div",{className:"space-y-1",children:P.map(s=>e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"truncate",children:s.name??s.email??`User #${s.id}`}),e.jsxs("span",{className:"text-muted-foreground",children:[s.pivot?.percentage??0,"%"]})]},s.id))})})]})]})})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(v,{className:"bg-card border-border",children:e.jsxs(b,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Config"}),e.jsx("p",{className:"text-base font-medium truncate",children:N?N.name:f?"Loading…":"—"})]}),e.jsx("div",{className:"w-64",children:e.jsxs(q,{disabled:f||o.length===0,value:p?.toString()??void 0,onValueChange:s=>j(Number(s)),children:[e.jsx(z,{children:e.jsx(H,{placeholder:f?"Loading configs…":"Choose config"})}),e.jsx(K,{children:o.map(s=>e.jsx(G,{value:s.id.toString(),children:s.name},s.id))})]})})]}),t&&e.jsx("p",{className:"mt-2 text-sm text-destructive",children:String(t)})]})}),f?e.jsx("div",{className:"h-72 bg-muted animate-pulse rounded-lg"}):o.length===0?e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No active task rating configuration found"})})}):N?e.jsx(he,{taskId:parseInt(c),config:N,onSubmit:I,isLoading:h}):e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Select a configuration to start rating"})})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Previous Ratings"}),h?e.jsx("div",{className:"space-y-4",children:Array.from({length:3}).map((s,x)=>e.jsx("div",{className:"h-32 bg-muted animate-pulse rounded-lg"},x))}):l.length===0?e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No ratings yet for this task"})})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-4",children:l.map(s=>e.jsx(de,{rating:s},s.id))}),i&&i.last_page>1&&e.jsx(v,{className:"bg-card border-border",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",i.from||0," to ",i.to||0," ","of ",i.total," results"]}),e.jsx(J,{children:e.jsxs(Q,{children:[e.jsx(w,{children:e.jsx(X,{onClick:d,className:i.current_page===1?"pointer-events-none opacity-50":"cursor-pointer"})}),M().map((s,x)=>e.jsx(w,{children:s==="ellipsis-start"||s==="ellipsis-end"?e.jsx(Y,{}):e.jsx(ee,{onClick:()=>R(s),isActive:i.current_page===s,className:"cursor-pointer",children:s})},x)),e.jsx(w,{children:e.jsx(se,{onClick:k,className:i.current_page===i.last_page?"pointer-events-none opacity-50":"cursor-pointer"})})]})})]})})})]})]})]})]})})};export{Me as default};
